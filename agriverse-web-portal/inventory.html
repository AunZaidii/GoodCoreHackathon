<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ¬ÙˆØ¯Û Ø³Ø§Ù…Ø§Ù† - AgriVerse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="sidebar-brand">
                    <i class="fas fa-warehouse fa-2x text-success mb-2"></i>
                    <h5 class="text-white">Ø§ÛŒÚ¯Ø±ÛŒ ÙˆØ±Ø³Û’</h5>
                    <small class="text-light">Ú¯ÙˆØ¯Ø§Ù… Ù…ÛŒÙ†ÛŒØ¬Ù…Ù†Ù¹</small>
                </div>
                
                <ul class="sidebar-nav">
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ</a></li>
                    <li><a href="add-produce.html"><i class="fas fa-plus-circle"></i> Ù†ÛŒØ§ Ø³Ø§Ù…Ø§Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº</a></li>
                    <li><a href="inventory.html" class="active"><i class="fas fa-boxes"></i> Ù…ÙˆØ¬ÙˆØ¯Û Ø³Ø§Ù…Ø§Ù†</a></li>
                    <li><a href="release-goods.html"><i class="fas fa-truck-loading"></i> Ø³Ø§Ù…Ø§Ù† Ù†Ú©Ø§Ù„ÛŒÚº</a></li>
                    <li><a href="spoiled-goods.html"><i class="fas fa-trash-alt"></i> Ø®Ø±Ø§Ø¨ Ù…Ø§Ù„ Ø±Ù¾ÙˆØ±Ù¹</a></li>
                    <li><a href="sales.html"><i class="fas fa-chart-bar"></i> ÙØ±ÙˆØ®Øª Ú©ÛŒ ØªÙØµÛŒÙ„</a></li>
                    <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ù„Ø§Ú¯ Ø¢Ø¤Ù¹</a></li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content">
                <!-- Top Bar -->
                <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm mb-4">
                    <h4 class="mb-0 text-primary">
                        <i class="fas fa-boxes me-2"></i>Ù…ÙˆØ¬ÙˆØ¯Û Ø³Ø§Ù…Ø§Ù†
                    </h4>
                    <a href="add-produce.html" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i> Ù†ÛŒØ§ Ø³Ø§Ù…Ø§Ù†
                    </a>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Ø­Ø§Ù„Øª</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">ØªÙ…Ø§Ù… Ø³Ø§Ù…Ø§Ù†</option>
                                    <option value="available">ÙØ±ÙˆØ®Øª Ú©Û’ Ù„ÛŒÛ’</option>
                                    <option value="sold">ÙØ±ÙˆØ®Øª ÛÙˆ Ú†Ú©Ø§</option>
                                    <option value="spoiled">Ø®Ø±Ø§Ø¨</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ù¾Ø±ÙˆÚˆÚ©Ù¹</label>
                                <select class="form-select" id="filterProduct">
                                    <option value="">ØªÙ…Ø§Ù… Ù¾Ø±ÙˆÚˆÚ©Ù¹Ø³</option>
                                    <option value="Ø¢Ù„Ùˆ">Ø¢Ù„Ùˆ</option>
                                    <option value="Ú¯Ù†Ø¯Ù…">Ú¯Ù†Ø¯Ù…</option>
                                    <option value="Ú†Ø§ÙˆÙ„">Ú†Ø§ÙˆÙ„</option>
                                    <option value="Ù¹Ù…Ø§Ù¹Ø±">Ù¹Ù…Ø§Ù¹Ø±</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ú¯ÙˆØ¯Ø§Ù…</label>
                                <select class="form-select" id="filterWarehouse">
                                    <option value="">ØªÙ…Ø§Ù… Ú¯ÙˆØ¯Ø§Ù…</option>
                                    <option value="Ù„Ø§ÛÙˆØ±">Ù„Ø§ÛÙˆØ±</option>
                                    <option value="ÙÛŒØµÙ„ Ø¢Ø¨Ø§Ø¯">ÙÛŒØµÙ„ Ø¢Ø¨Ø§Ø¯</option>
                                    <option value="Ù…Ù„ØªØ§Ù†">Ù…Ù„ØªØ§Ù†</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ØªÙ„Ø§Ø´</label>
                                <input type="text" class="form-control" id="searchInventory" placeholder="Ú©Ø³Ø§Ù† ÛŒØ§ Ù¾Ø±ÙˆÚˆÚ©Ù¹ ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº...">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Ø³Ø§Ù…Ø§Ù† Ú©ÛŒ ÙÛØ±Ø³Øª</h5>
                        <div class="text-muted">
                            <span id="totalRecords">0</span> Ø±ÛŒÚ©Ø§Ø±ÚˆØ²
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ù¾Ø±ÙˆÚˆÚ©Ù¹</th>
                                        <th>Ú©Ø³Ø§Ù†</th>
                                        <th>Ù…Ù‚Ø¯Ø§Ø±</th>
                                        <th>Ù‚ÛŒÙ…Øª</th>
                                        <th>Ù…Ø¹ÛŒØ§Ø±</th>
                                        <th>Ú¯ÙˆØ¯Ø§Ù…</th>
                                        <th>Ø­Ø§Ù„Øª</th>
                                        <th>Ø¹Ù…Ù„</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-5" style="display: none;">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Ú©ÙˆØ¦ÛŒ Ø³Ø§Ù…Ø§Ù† Ø¯Ø³ØªÛŒØ§Ø¨ Ù†ÛÛŒÚº</h5>
                            <p class="text-muted">Ù¾ÛÙ„Ø§ Ø³Ø§Ù…Ø§Ù† Ø´Ø§Ù…Ù„ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ù†ÛŒÚ†Û’ Ø¯ÛŒÛ’ Ú¯Ø¦Û’ Ø¨Ù¹Ù† Ù¾Ø± Ú©Ù„Ú© Ú©Ø±ÛŒÚº</p>
                            <a href="add-produce.html" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i> Ù†ÛŒØ§ Ø³Ø§Ù…Ø§Ù† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/inventory.js"></script>
    
    <script>
// Load inventory when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“¦ Loading inventory page...');
    inventory.loadInventoryTable();
    setupInventoryFilters();
});

// Enhanced filter setup
function setupInventoryFilters() {
    const filterStatus = document.getElementById('filterStatus');
    const filterProduct = document.getElementById('filterProduct');
    const filterWarehouse = document.getElementById('filterWarehouse');
    const searchInput = document.getElementById('searchInventory');

    // Clear filters button
    const clearBtn = document.createElement('button');
    clearBtn.type = 'button';
    clearBtn.className = 'btn btn-outline-secondary';
    clearBtn.innerHTML = '<i class="fas fa-times"></i> ØµØ§Ù Ú©Ø±ÛŒÚº';
    clearBtn.onclick = clearFilters;
    
    // Add clear button to filter section
    const filterCard = document.querySelector('.card.mb-4 .card-body');
    if (filterCard) {
        const filterRow = filterCard.querySelector('.row');
        const clearCol = document.createElement('div');
        clearCol.className = 'col-md-12 mt-3';
        clearCol.appendChild(clearBtn);
        filterRow.appendChild(clearCol);
    }

    // Add event listeners
    if (filterStatus) filterStatus.addEventListener('change', applyFilters);
    if (filterProduct) filterProduct.addEventListener('change', applyFilters);
    if (filterWarehouse) filterStatus.addEventListener('change', applyFilters);
    if (searchInput) searchInput.addEventListener('input', applyFilters);
}

// Apply filters function
async function applyFilters() {
    const filters = {
        status: document.getElementById('filterStatus')?.value || '',
        product_name: document.getElementById('filterProduct')?.value || '',
        warehouse: document.getElementById('filterWarehouse')?.value || '',
        search: document.getElementById('searchInventory')?.value || ''
    };

    console.log('ğŸ” Applying filters:', filters);
    
    try {
        const data = await inventory.getInventory(filters);
        updateInventoryTable(data);
    } catch (error) {
        console.error('Error applying filters:', error);
        showInventoryError('ÙÙ„Ù¹Ø±Ø² Ù„Ø§Ú¯Ùˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ');
    }
}

// Clear all filters
function clearFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterProduct').value = '';
    document.getElementById('filterWarehouse').value = '';
    document.getElementById('searchInventory').value = '';
    
    // Reload full inventory
    inventory.loadInventoryTable();
}

// Update inventory table with data
function updateInventoryTable(data) {
    const inventoryTable = document.getElementById('inventoryTable');
    const emptyState = document.getElementById('emptyState');
    const totalRecords = document.getElementById('totalRecords');
    
    if (!inventoryTable) return;

    if (data.length === 0) {
        inventoryTable.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        if (totalRecords) totalRecords.textContent = '0';
        return;
    }

    if (emptyState) emptyState.style.display = 'none';
    if (totalRecords) totalRecords.textContent = data.length;

    inventoryTable.innerHTML = data.map(item => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-${getProductIcon(item.product_name)} text-primary me-2"></i>
                    <div>
                        <strong>${item.product_name}</strong>
                        <br><small class="text-muted">${inventory.formatDate(item.created_at)}</small>
                    </div>
                </div>
            </td>
            <td>
                <div class="fw-semibold">${item.farmer_name}</div>
                <small class="text-muted">${item.farmer_phone}</small>
            </td>
            <td>
                <span class="badge bg-light text-dark border">
                    ${item.quantity} Ú©Ù„Ùˆ
                </span>
            </td>
            <td>
                <strong>${item.price_per_kg}</strong>
                <br><small class="text-muted">Ø±ÙˆÙ¾Û’ ÙÛŒ Ú©Ù„Ùˆ</small>
            </td>
            <td>${inventory.getQualityBadge(item.quality)}</td>
            <td>
                <span class="badge bg-info">${item.warehouse}</span>
            </td>
            <td>${inventory.getStatusBadge(item.status)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewItemDetails(${item.id})" title="Ø¯ÛŒÚ©Ú¾ÛŒÚº">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="markAsSold(${item.id})" title="ÙØ±ÙˆØ®Øª Ú©Ø±ÛŒÚº">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteInventoryItem(${item.id})" title="Ø­Ø°Ù Ú©Ø±ÛŒÚº">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Get product icon
function getProductIcon(productName) {
    const iconMap = {
        'Ø¢Ù„Ùˆ': 'potato',
        'Ú¯Ù†Ø¯Ù…': 'wheat',
        'Ú†Ø§ÙˆÙ„': 'rice',
        'Ù¹Ù…Ø§Ù¹Ø±': 'apple-alt',
        'Ù¾ÛŒØ§Ø²': 'onion',
        'Ø¯ÙˆØ¯Ú¾': 'wine-bottle',
        'Ø³Ø¨Ø²ÛŒØ§Úº': 'carrot'
    };
    
    const defaultIcons = {
        'potato': 'seedling',
        'wheat': 'seedling', 
        'rice': 'seedling',
        'onion': 'apple-alt',
        'wine-bottle': 'wine-bottle'
    };
    
    const icon = iconMap[productName] || 'box';
    return defaultIcons[icon] || icon;
}

// View item details
function viewItemDetails(itemId) {
    inventory.getInventory().then(items => {
        const item = items.find(i => i.id == itemId);
        if (item) {
            const modalHtml = `
                <div class="modal fade" id="itemModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Ø³Ø§Ù…Ø§Ù† Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Ø¨Ù†ÛŒØ§Ø¯ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h6>
                                        <p><strong>Ù¾Ø±ÙˆÚˆÚ©Ù¹:</strong> ${item.product_name}</p>
                                        <p><strong>Ú©Ø³Ø§Ù†:</strong> ${item.farmer_name}</p>
                                        <p><strong>ÙÙˆÙ†:</strong> ${item.farmer_phone}</p>
                                        <p><strong>Ù…Ù‚Ø¯Ø§Ø±:</strong> ${item.quantity} Ú©Ù„Ùˆ</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Ú©Ø§Ø±ÙˆØ¨Ø§Ø±ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h6>
                                        <p><strong>Ù‚ÛŒÙ…Øª:</strong> ${item.price_per_kg} Ø±ÙˆÙ¾Û’ ÙÛŒ Ú©Ù„Ùˆ</p>
                                        <p><strong>Ù…Ø¹ÛŒØ§Ø±:</strong> ${inventory.getQualityBadge(item.quality)}</p>
                                        <p><strong>Ú¯ÙˆØ¯Ø§Ù…:</strong> ${item.warehouse}</p>
                                        <p><strong>Ø­Ø§Ù„Øª:</strong> ${inventory.getStatusBadge(item.status)}</p>
                                    </div>
                                </div>
                                ${item.notes ? `<div class="mt-3"><strong>Ù†ÙˆÙ¹Ø³:</strong> ${item.notes}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('itemModal');
            if (existingModal) existingModal.remove();
            
            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('itemModal'));
            modal.show();
        }
    });
}

// Mark item as sold
async function markAsSold(itemId) {
    if (confirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø³Ø§Ù…Ø§Ù† Ú©Ùˆ ÙØ±ÙˆØ®Øª Ø´Ø¯Û Ù‚Ø±Ø§Ø± Ø¯ÛŒÙ†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ')) {
        try {
            await inventory.updateInventoryItem(itemId, { status: 'sold' });
            showInventoryAlert('Ø³Ø§Ù…Ø§Ù† Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ÙØ±ÙˆØ®Øª Ø´Ø¯Û Ù‚Ø±Ø§Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§', 'success');
            inventory.loadInventoryTable();
            
            // Update dashboard if available
            if (window.dashboard && window.dashboard.loadDashboardData) {
                window.dashboard.loadDashboardData();
            }
        } catch (error) {
            showInventoryAlert('Ø®Ø±Ø§Ø¨ÛŒ: ' + error.message, 'error');
        }
    }
}

// Delete inventory item
async function deleteInventoryItem(itemId) {
    if (confirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø³Ø§Ù…Ø§Ù† Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ ÛŒÛ Ø¹Ù…Ù„ ÙˆØ§Ù¾Ø³ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ØªØ§Û”')) {
        try {
            await inventory.deleteInventoryItem(itemId);
            showInventoryAlert('Ø³Ø§Ù…Ø§Ù† Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù ÛÙˆ Ú¯ÛŒØ§', 'success');
            inventory.loadInventoryTable();
        } catch (error) {
            showInventoryAlert('Ø®Ø±Ø§Ø¨ÛŒ: ' + error.message, 'error');
        }
    }
}

// Show alert on inventory page
function showInventoryAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const mainContent = document.querySelector('.main-content');
    mainContent.insertBefore(alertDiv, mainContent.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Show error state
function showInventoryError(message) {
    const inventoryTable = document.getElementById('inventoryTable');
    if (inventoryTable) {
        inventoryTable.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="inventory.loadInventoryTable()">
                        Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚº
                    </button>
                </td>
            </tr>
        `;
    }
}
</script>
</body>
</html>